SHELL := /bin/bash

GITHUB_SSH_KEY ?= $(HOME)/.ssh/id_rsa

NRO ?= $(shell cat NRO_NAME | tr '[:upper:]' '[:lower:]' | tr -d '[:punct:]' | tr ' ' '-')
ifeq ($(strip $(NRO)),)
$(error NRO name not set, please run ./configure.sh)
endif

SERVICE_ACCOUNT_NAME ?= $(shell cat SERVICE_ACCOUNT_NAME)

ifeq ("$(wildcard secrets/service-accounts/$(SERVICE_ACCOUNT_NAME).json)","")
$(error Service account file not found: secrets/service-accounts/$(SERVICE_ACCOUNT_NAME).json)
endif

include secrets/common
export $(shell sed 's/=.*//' secrets/common)
include secrets/env.$(NRO)
export $(shell sed 's/=.*//' secrets/env.$(NRO))

###############################################################################

DEFAULT_GOAL: all

.PHONY: all
all: test prompt init env deploy done

.PHONY: test
test:
	env | sort

.PHONY: prompt
prompt:
	@prompt.sh

################################################################################

.PHONY: init
init: init-repo init-project init-db init-bucket

.PHONY: init-repo
init-repo:
	init_github_repo.sh

.PHONY: init-project
init-project:
	init_circle_project.sh

.PHONY: init-db
init-db:
	init_db.sh

.PHONY: init-bucket
init-bucket:
	init_bucket.sh

################################################################################
.PHONY: env
env: env-ci env-wp

.PHONY: env-ci
env-ci:
	init_ci_secrets.sh

.PHONY: env-wp
env-wp:
	init_wp_environment.sh

################################################################################

.PHONY: delete-yes-i-mean-it
delete-yes-i-mean-it:	delete-repo-yes-i-mean-it delete-db-yes-i-mean-it delete-bucket-yes-i-mean-it

.PHONY: delete-repo-yes-i-mean-it
delete-repo-yes-i-mean-it:
	FORCE_DELETE="true" delete_github_repo.sh

.PHONY: delete-db-yes-i-mean-it
delete-db-yes-i-mean-it:
	FORCE_DELETE="true" delete_db.sh

.PHONY: delete-bucket-yes-i-mean-it
delete-bucket-yes-i-mean-it:
	FORCE_DELETE="true" delete_bucket.sh

################################################################################

.PHONY: delete
delete:	delete-repo delete-db delete-bucket

.PHONY: delete-repo
delete-repo:
	delete_github_repo.sh

.PHONY: delete-db
delete-db:
	delete_db.sh

.PHONY: delete-bucket
delete-bucket:
	delete_bucket.sh

################################################################################

.PHONY: deploy
deploy:
	trigger_build.sh

################################################################################

.PHONY: init-service-account
init-service-account:
	init_service_account.sh

.PHONY: delete-service-account-yes-i-mean-it
delete-service-account-yes-i-mean-it:
	delete_service_account.sh

################################################################################

.PHONY: done
done:
	@echo "@todo: Add user key for read/write operations"
	@echo "Visit https://circleci.com/gh/greenpeace/$(CONTAINER_PREFIX)/edit#checkout"
	@echo
	@echo "@todo: Configure Google Apps OAUTH credentials"
	@echo "Visit https://console.cloud.google.com/apis/credentials"
	@echo
